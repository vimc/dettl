<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using dettl for importing data • dettl</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using dettl for importing data">
<meta property="og:description" content="dettl">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dettl</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.17</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/dettl.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="dettl_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="dettl_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="dettl_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using dettl for importing data</h1>
                        <h4 class="author">Robert Ashton</h4>
            
            <h4 class="date">2020-11-03</h4>
      
      
      <div class="hidden name"><code>dettl.Rmd</code></div>

    </div>

    
    
<p>Dettl provides a way to make data tidying and ingestion into a database easier, more testable and more robust. We do that by employing an ETL (extract, transform, load) like workflow to separate out different concerns of your data import and allow testing after each stage.</p>
<div id="etl" class="section level2">
<h2 class="hasAnchor">
<a href="#etl" class="anchor"></a>ETL</h2>
<p>ETL is a pattern for general copying of data from one or more sources to another destination which expects the data in a different form from the sources. It consists of three basic steps</p>
<p><strong>Extract</strong> - Step is responsible for selecting and accessing any required data from relevant sources (local files or DB). The data is read into memory and can be verified by running a set of tests after step has completed.</p>
<p><strong>Transform</strong> - Step is responsible for transforming the extracted data into a form ready for loading into the destination database. Expect this is where the bulk of the work will be done. The transformed data can be verified by running a set of tests after the step has completed.</p>
<p><strong>Load</strong> - Step is responsible for loading the transformed data into the destination database. A set of post-load tests can be defined which will be run after the data is loaded into the database. If any of the tests fail the DB update will roll back, otherwise changes are committed.</p>
</div>
<div id="repository-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#repository-setup" class="anchor"></a>Repository setup</h2>
<p>Dettl requires a config at the top level of a repository called <code>dettl_config.yml</code> which describes database connection information. Individual imports are then organised in separate subdirectories and must contain a config file <code>dettl.yml</code> which contains information relating to the import mode, files to be sourced and tests to be run. These subdirectories will be created automatically by using <code>dettl_new</code>.</p>
<p>A typical repository might look like</p>
<pre><code>project_directory
|── import_1
|   |── dettl.yml
|── import_2
|   |── dettl.yml
|── other imports ...
|── dettl_config.yml</code></pre>
</div>
<div id="dettl_config-yml" class="section level2">
<h2 class="hasAnchor">
<a href="#dettl_config-yml" class="anchor"></a>dettl_config.yml</h2>
<p>This needs to be setup manually and contains configuration at the project level used to configure DB connection information for any database which you wish to import to. Note that you must specify a <code>log_table</code> where run information is written after each import. See below for an example setup.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">db</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> RSQLite::SQLite</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="at">    </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="at">      </span><span class="fu">dbname</span><span class="kw">:</span><span class="at"> test.sqlite</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="at">    </span><span class="fu">log_table</span><span class="kw">:</span><span class="at"> dettl_import_log</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="at">  </span><span class="fu">uat</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="at">    </span><span class="fu">driver</span><span class="kw">:</span><span class="at"> RPostgres::Postgresql</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="at">    </span><span class="fu">args</span><span class="kw">:</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="at">      </span><span class="fu">dbname</span><span class="kw">:</span><span class="at"> montagu</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="at">      </span><span class="fu">host</span><span class="kw">:</span><span class="at"> https://example.com</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">12345</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="at">      </span><span class="fu">user</span><span class="kw">:</span><span class="at"> example</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="at">      </span><span class="fu">password</span><span class="kw">:</span><span class="at"> password</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="at">    </span><span class="fu">log_table</span><span class="kw">:</span><span class="at"> dettl_import_log</span></span></code></pre></div>
</div>
<div id="creating-a-new-etl-import" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-new-etl-import" class="anchor"></a>Creating a new ETL import</h2>
<p>If you want to create a new import within an existing project this can be done by opening the project as an RStudio project and using <code><a href="../reference/dettl_new.html">dettl_new()</a></code>.</p>
<pre><code>import_name &lt;- dettl::dettl_new("person_information")</code></pre>
<p>This will create a new directory called <code>person_information</code> prepended with the current date containing: * the default <code>dettl.yml</code> config - by default setup to run in append mode using automatic load * an R file <code>R/extract.R</code> containing a template extract function * an R file <code>R/transform.R</code> containing a template transform function * an R file <code>R/verification_queries.R</code> containing test queries for load stage * 3 test files <code>tests/test_extract.R</code>, <code>tests/test_transform.R</code>, <code>tests/test_load.R</code> containing testthat templates for testing after each stage of the import</p>
<p>If you want to create a new import within a new project then you will need to manually create a new RStudio project and create a <code>dettl_config.yml</code> file. You can then proceed as above.</p>
</div>
<div id="developing-the-import" class="section level2">
<h2 class="hasAnchor">
<a href="#developing-the-import" class="anchor"></a>Developing the import</h2>
<div id="extract" class="section level3">
<h3 class="hasAnchor">
<a href="#extract" class="anchor"></a>Extract</h3>
<p>To develop a complete import you need to implement the extract and transform stages.</p>
<p>Open the created <code>R/extract.R</code> file and implement the templated <code>extract</code> function. This can delegate to other R functions written elsewhere. If you add any other R files they will need to be added to the list of <code>sources</code> in the <code>dettl.yml</code>. The extract code should just read data the required data into memory and do no more. For our simple example we want to read from a csv.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">extract</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">raw_data</span><span class="op">$</span><span class="va">people</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/people.csv"</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">raw_data</span>
<span class="op">}</span></pre></div>
<p>You should also define some tests for this stage in the <code>R/test_extract.R</code> file. These are written using the <a href="http://r-pkgs.had.co.nz/tests.html">testthat package</a>. The extracted data is made available via the variable <code>extracted_data</code> which can be used from within the configured test file. An example test to check that our extract function has extracted 3 rows of data would be.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu">context</span><span class="op">(</span><span class="st">"extract"</span><span class="op">)</span>

<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"extracted data contains 3 rows"</span>, <span class="op">{</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">extracted_data</span><span class="op">$</span><span class="va">people</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>After completing the implementation of the extract stage you can run just that step to check that the extracted data looks as expected. Note that the directory must be under version control and up to date with remote to run the import. This check is skipped if running in <code>dry_run</code> mode. See <a href="#run">Running the import</a> for more details about this. When creating a new import also pass the database which this import is for, this must match one of the databases configured in the <code>dettl_config.yml</code>. See example below for a previously configured example. Note that <code>import_path</code> is the path to an import directory with structure like above.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">import</span> <span class="op">&lt;-</span> <span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl.html">dettl</a></span><span class="op">(</span><span class="va">import_path</span>, db_name <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span>
<span class="va">import</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad6ffc51eb/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; 🥇 Your tests deserve a gold medal 🥇</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="va">extracted_data</span> <span class="op">&lt;-</span> <span class="va">import</span><span class="op">$</span><span class="fu">get_extracted_data</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>The extracted data can be inspected to ensure it looks as expected.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">extracted_data</span><span class="op">)</span>
<span class="co">#&gt; $people</span>
<span class="co">#&gt;    name age height</span>
<span class="co">#&gt; 1 Alice  25    175</span>
<span class="co">#&gt; 2   Bob  43    187</span>
<span class="co">#&gt; 3 Clive  76    163</span></pre></div>
</div>
<div id="transform" class="section level3">
<h3 class="hasAnchor">
<a href="#transform" class="anchor"></a>Transform</h3>
<p>Open the created <code>R/transform.R</code> file and implement the templated <code>transform</code> function. Like the extract stage this can delegate to functions defined in other files providing that the files used are added to the <code>sources</code> block in the config. The <code>transform</code> function should return data as a named list of data frames where each data frame represents a table from the database. The names of the data frames need to match the names of tables in the database. You can write some tests the check the transformed data which will be run automatically after the transform step is run. In addition to user specified tests we check that the returned data conforms to the DB schema and fail if it does not do so. For example for our simple people example our transform code could be something like</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">transform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">extracted_data</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">transformed_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">transformed_data</span><span class="op">$</span><span class="va">people</span> <span class="op">&lt;-</span> <span class="va">extracted_data</span><span class="op">$</span><span class="va">people</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">extracted_data</span><span class="op">$</span><span class="va">people</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;</span> <span class="fl">50</span><span class="op">)</span>, <span class="op">]</span>
  <span class="va">transformed_data</span>
<span class="op">}</span></pre></div>
<p>and our user defined test</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu">context</span><span class="op">(</span><span class="st">"transform"</span><span class="op">)</span>

<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"transformed data contains 2 rows"</span>, <span class="op">{</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">transformed_data</span><span class="op">$</span><span class="va">people</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>Like with developing the extract stage you can now run the import up the transform step to check it is working though you should try to add any checks required for accepting the transform stage to the test file.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad6ffc51eb/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="va">transformed_data</span> <span class="op">&lt;-</span> <span class="va">import</span><span class="op">$</span><span class="fu">get_transformed_data</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>The transformed data can be inspected to ensure it looks as expected.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">transformed_data</span><span class="op">)</span>
<span class="co">#&gt; $people</span>
<span class="co">#&gt;    name age height</span>
<span class="co">#&gt; 1 Alice  25    175</span>
<span class="co">#&gt; 2   Bob  43    187</span></pre></div>
</div>
<div id="dettl_auto_load" class="section level3">
<h3 class="hasAnchor">
<a href="#dettl_auto_load" class="anchor"></a>Load</h3>
<p>By default dettl will use an automatic load step to write data to the database. At its most simple this will just take the named list of <code>transformed_data</code> and append each of these data frames to the table in the database with matching name. To use the automatic load step requires defining that the automatic load should be used in the load block of <code>dettl.yml</code> e.g.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">load</span><span class="kw">:</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="at">  </span><span class="fu">automatic</span><span class="kw">:</span><span class="at"> </span><span class="ch">TRUE</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="at">  </span><span class="fu">verification_queries</span><span class="kw">:</span><span class="at"> test_queries</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> R/test_load.R</span></span></code></pre></div>
<p>The automatic load will load data respecting primary key constraints which are read automatically from the database. For example if we want to load data where we have <code>transformed_data</code> taking the form</p>
<table class="table">
<caption>people</caption>
<thead><tr class="header">
<th align="right">id</th>
<th align="left">name</th>
<th align="right">age</th>
<th align="right">height</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">Alice</td>
<td align="right">25</td>
<td align="right">175</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Bob</td>
<td align="right">45</td>
<td align="right">187</td>
</tr>
</tbody>
</table>
<table class="table">
<caption>jobs</caption>
<thead><tr class="header">
<th align="right">person</th>
<th align="left">job</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">researcher</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">developer</td>
</tr>
</tbody>
</table>
<p>where <code>id</code> is the primary key of table <code>people</code> which is used as a foreign key for the <code>person</code> column of table <code>jobs</code>. To support linking between these tables in the transformed data use temporary unique IDs to associate the new rows of data with each other. The temporary unique IDs can be anything as they will be updated when the new records are added but using negative numbers is a good way to make clear the separation between temporary ID and real db entries. If you want to link to an existing entry in the database by its primary ID then use that exact ID as the field value.</p>
<p>Note that the default automatic load will only append to existing tables, if you need to create new tables see <a href="#create_mode">create mode</a>.</p>
<p>The important implementation for this stage is the testing. The load stage will be run in a transaction then the tests will be run. If any of the tests fail the transaction will be rolled back, otherwise it will be committed. You can write two types of test here, the first simplest is using the active connection to the database to query the loaded data and test the output. For example</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu">context</span><span class="op">(</span><span class="st">"load"</span><span class="op">)</span>

<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"people has 2 rows 2"</span>, <span class="op">{</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) from people"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>These type of tests can only be used to look at the DB after the load has been done. You can also define tests which can test for changes in the DB between before and after the load has run. These require 2 steps.</p>
<p>First you need to define a function to query the database to get data you’re interested in. e.g.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">test_queries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">values</span><span class="op">$</span><span class="va">count</span> <span class="op">&lt;-</span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT count(*) from people"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>
  <span class="va">values</span>
<span class="op">}</span></pre></div>
<p>This should write the data into a list with meaningful names as these names will be used in the test. You need to then define the function used in the <code>dettl.yml</code> config in the <code>load</code> block using the following,</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">load</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="at">  </span><span class="fu">func</span><span class="kw">:</span><span class="at"> load</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="at">  </span><span class="fu">verification_queries</span><span class="kw">:</span><span class="at"> test_queries</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> R/test_load.R</span></span></code></pre></div>
<p>Making sure any additional R files have been added to the <code>sources</code> block. The <code>verification_queries</code> will be then run before and after the DB update has been run and the output made available to the tests as lists <code>before</code> and <code>after</code> so differences can be tested e.g.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu">context</span><span class="op">(</span><span class="st">"load"</span><span class="op">)</span>

<span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_that.html">test_that</a></span><span class="op">(</span><span class="st">"No of rows in people increases by 2"</span>, <span class="op">{</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">after</span><span class="op">$</span><span class="va">count</span>, <span class="va">before</span><span class="op">$</span><span class="va">count</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>After this stage has been implemented the import can be run end-to-end.</p>
</div>
</div>
<div id="run" class="section level2">
<h2 class="hasAnchor">
<a href="#run" class="anchor"></a>Running the import</h2>
<p>The import can be run in one of two ways. You can either run the import up to a specified stage with one function call or if you require more control you can initialise an import object and run each stage step by step.</p>
<div id="run-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#run-functions" class="anchor"></a>Run functions</h3>
<p>To use the run functions to run an import up to a specified stage you need to know the path to the import and the name of the database you want to use for the import. You can leave the <code>db_name</code> field blank to use the first database configured in the <code>dettl_config.yml</code> file.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">import</span> <span class="op">&lt;-</span> <span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl_run.html">dettl_run</a></span><span class="op">(</span><span class="va">import_path</span>, db_name <span class="op">=</span> <span class="st">"test"</span>, stage <span class="op">=</span> <span class="st">"extract"</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span></pre></div>
<p>This returns the import object which you can work further with and returns a list of processed data. You can see the extracted data at</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">get_extracted_data</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $people</span>
<span class="co">#&gt;    name age height</span>
<span class="co">#&gt; 1 Alice  25    175</span>
<span class="co">#&gt; 2   Bob  43    187</span>
<span class="co">#&gt; 3 Clive  76    163</span></pre></div>
<p>To execute the transform stage, call the same run function with <code>stage = c("extract", "transform")</code>. This again returns the import object.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">import</span> <span class="op">&lt;-</span> <span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl_run.html">dettl_run</a></span><span class="op">(</span><span class="va">import_path</span>, stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"extract"</span>, <span class="st">"transform"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span></pre></div>
<p>You can inspect the transformed data using</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">get_transformed_data</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $people</span>
<span class="co">#&gt;    name age height</span>
<span class="co">#&gt; 1 Alice  25    175</span>
<span class="co">#&gt; 2   Bob  43    187</span></pre></div>
<p>You can run the load stage</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl_run.html">dettl_run</a></span><span class="op">(</span><span class="va">import_path</span>, stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"extract"</span>, <span class="st">"transform"</span>, <span class="st">"load"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; Way to go!</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="co">#&gt; Running load /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad133128f3/person_information</span>
<span class="co">#&gt; Running load in a transaction:</span>
<span class="co">#&gt;  - Running test queries before making any changes</span>
<span class="co">#&gt;  - Running load step</span>
<span class="co">#&gt;  - Running test queries after making changes</span>
<span class="co">#&gt;  - Running load tests R/test_load.R</span>
<span class="co">#&gt; load: </span>
<span class="co">#&gt; load: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All tests passed, commiting changes to database.</span></pre></div>
<p>You can run multiple stages together or the whole import end-to-end using <code>dettl_run</code>. This will make changes to the database unless run in <code>dry_run</code> mode.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl_run.html">dettl_run</a></span><span class="op">(</span><span class="va">import_path</span>, db_name <span class="op">=</span> <span class="st">"test"</span>, stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"extract"</span>, <span class="st">"transform"</span>, <span class="st">"load"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad75d77a49/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad75d77a49/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="co">#&gt; Running load /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad75d77a49/person_information</span>
<span class="co">#&gt; Running load in a transaction:</span>
<span class="co">#&gt;  - Running test queries before making any changes</span>
<span class="co">#&gt;  - Running load step</span>
<span class="co">#&gt;  - Running test queries after making changes</span>
<span class="co">#&gt;  - Running load tests R/test_load.R</span>
<span class="co">#&gt; load: </span>
<span class="co">#&gt; load: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All tests passed, commiting changes to database.</span></pre></div>
<p>You can also save the output data as an xlsx from the stages being run. This can save to a specified file or to a temporary file if pass <code>save = TRUE</code></p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl_run.html">dettl_run</a></span><span class="op">(</span><span class="va">import_path</span>, db_name <span class="op">=</span> <span class="st">"test"</span>, stage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"extract"</span>, <span class="st">"transform"</span><span class="op">)</span>, save <span class="op">=</span> <span class="va">temp_file</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad4d0968ca/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad4d0968ca/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="co">#&gt; Saved extract data to /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T//RtmpjWqfLE/file6ad6a978677</span>
<span class="co">#&gt; Saved transform data to /var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T//RtmpjWqfLE/file6ad6a978677</span>
<span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="va">temp_file</span><span class="op">)</span>
<span class="co">#&gt; [1] "extracted_people"   "transformed_people"</span></pre></div>
</div>
<div id="working-with-import-object" class="section level3">
<h3 class="hasAnchor">
<a href="#working-with-import-object" class="anchor"></a>Working with import object</h3>
<p>To run the import using the object first create a new import object using the name of the directory containing the import you want to run. Again note that the <code>import_path</code> here is the path to import directory.</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">import</span> <span class="op">&lt;-</span> <span class="fu">dettl</span><span class="fu">::</span><span class="fu"><a href="../reference/dettl.html">dettl</a></span><span class="op">(</span><span class="va">import_path</span>, db_name <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span></pre></div>
<p>You can then run the import by running</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad492bdb9b/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="va">import</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad492bdb9b/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="va">import</span><span class="op">$</span><span class="fu">load</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running load /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad492bdb9b/person_information</span>
<span class="co">#&gt; Running load in a transaction:</span>
<span class="co">#&gt;  - Running test queries before making any changes</span>
<span class="co">#&gt;  - Running load step</span>
<span class="co">#&gt;  - Running test queries after making changes</span>
<span class="co">#&gt;  - Running load tests R/test_load.R</span>
<span class="co">#&gt; load: </span>
<span class="co">#&gt; load: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All tests passed, commiting changes to database.</span></pre></div>
<p>This will fail if any of the stages fail.</p>
<p>You can run the import up to just a specific point to view the output if desired - which should be useful for debugging any import problems e.g.</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad13a3a9e9/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="va">import</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad13a3a9e9/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span></pre></div>
<p>Will run just the <code>extract</code> and <code>transform</code> stages of the import. Note that when any stage is run we automatically run any of the tests associated with that stage which have been configured. You can use the import object to view the extracted or transformed data.</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="va">extracted_data</span> <span class="op">&lt;-</span> <span class="va">import</span><span class="op">$</span><span class="fu">get_extracted_data</span><span class="op">(</span><span class="op">)</span>
<span class="va">transformed_data</span> <span class="op">&lt;-</span> <span class="va">import</span><span class="op">$</span><span class="fu">get_transformed_data</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>You can then run the load stage once you are satisfied the transformed_data looks coorect.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">load</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running load /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad13a3a9e9/person_information</span>
<span class="co">#&gt; Running load in a transaction:</span>
<span class="co">#&gt;  - Running test queries before making any changes</span>
<span class="co">#&gt;  - Running load step</span>
<span class="co">#&gt;  - Running test queries after making changes</span>
<span class="co">#&gt;  - Running load tests R/test_load.R</span>
<span class="co">#&gt; load: </span>
<span class="co">#&gt; load: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All tests passed, commiting changes to database.</span></pre></div>
<p>We can then inspect the database to see that the data has indeed been loaded</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="va">con</span> <span class="op">&lt;-</span> <span class="va">import</span><span class="op">$</span><span class="fu">get_connection</span><span class="op">(</span><span class="op">)</span>
<span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM people"</span><span class="op">)</span>
<span class="co">#&gt;   id  name age height</span>
<span class="co">#&gt; 1  1 Alice  25    175</span>
<span class="co">#&gt; 2  2   Bob  43    187</span></pre></div>
</div>
<div id="dry-run" class="section level3">
<h3 class="hasAnchor">
<a href="#dry-run" class="anchor"></a>Dry run</h3>
<p>The import can be run in <code>dry_run</code> which will be useful for development.</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="va">import</span><span class="op">$</span><span class="fu">extract</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running extract /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad32500270/person_information</span>
<span class="co">#&gt; Running extract tests R/test_extract.R</span>
<span class="co">#&gt; extract: </span>
<span class="co">#&gt; extract: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All extract tests passed.</span>
<span class="va">import</span><span class="op">$</span><span class="fu">transform</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Running transform /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad32500270/person_information</span>
<span class="co">#&gt; Running transform tests R/test_transform.R</span>
<span class="co">#&gt; transform: </span>
<span class="co">#&gt; transform: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All transform tests passed.</span>
<span class="va">import</span><span class="op">$</span><span class="fu">load</span><span class="op">(</span>dry_run <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Running load /private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpjWqfLE/file6ad32500270/person_information</span>
<span class="co">#&gt; Running load in a transaction:</span>
<span class="co">#&gt;  - Running test queries before making any changes</span>
<span class="co">#&gt;  - Running load step</span>
<span class="co">#&gt;  - Running test queries after making changes</span>
<span class="co">#&gt;  - Running load tests R/test_load.R</span>
<span class="co">#&gt; load: </span>
<span class="co">#&gt; load: .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ══ DONE ════════════════════════════════════════════════════════════════════════</span>
<span class="co">#&gt; All tests passed, rolling back dry run import.</span></pre></div>
<p>This will rollback any changes which have been made to the database before the connection is closed. Note that it also skips the check that the git repository is up to date with remote and so should be used when developing the import.</p>
</div>
</div>
<div id="other-stuff" class="section level2">
<h2 class="hasAnchor">
<a href="#other-stuff" class="anchor"></a>Other stuff</h2>
<div id="create_mode" class="section level3">
<h3 class="hasAnchor">
<a href="#create_mode" class="anchor"></a>I want to write an import which creates a table</h3>
<p>If you want to create a table during your import you need to switch the import mode. This is done in the <code>dettl.yml</code> configuration</p>
<pre><code>dettl:
  mode: create</code></pre>
<p>Create mode imports will skip some of the checks append imports do e.g. checks that the transformed data matches tables in the DB schema. The automatic load can still be used and will create each of the tables in the transformed data. Note that create and appending to tables cannot be mixed within an import.</p>
</div>
<div id="i-want-to-write-a-custom-load" class="section level3">
<h3 class="hasAnchor">
<a href="#i-want-to-write-a-custom-load" class="anchor"></a>I want to write a custom load</h3>
<p>Dettl allows writing a custom load if the automatic load does not achieve the desired effect. You might want to use a custom load if you want to run an <code>UPDATE</code> query on the database. To do this update the <code>dettl.yml</code> for the report to use a user defined load</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">load</span><span class="kw">:</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="at">  </span><span class="fu">func</span><span class="kw">:</span><span class="at"> load</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="at">  </span><span class="fu">verification_queries</span><span class="kw">:</span><span class="at"> test_queries</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> R/test_load.R</span></span></code></pre></div>
<p>then add a function matching the name specified in the config, in our example this is just <code>load</code> which takes the transformed data and a DB connection e.g.</p>
<div class="sourceCode" id="cb33"><pre class="downlit">
<span class="va">load</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">transformed_data</span>, <span class="va">con</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">## Do something</span>
<span class="op">}</span></pre></div>
<p>Note that the containing file must be in the list of sources for the import. Note also that if you are using a custom load dettl won’t automatically fix key references for you and you will need to manage this manually. Do not specify numerical IDs where the database would normally do that with a serial. Leave the IDs out and let the database generate those and if you require the IDs in another place then use a sql query with <code>RETURNING id</code> to <a href="https://www.postgresql.org/docs/12/dml-returning.html">fetch back the assigned serial IDs</a>.</p>
</div>
<div id="i-want-to-use-the-automatic-load-but-make-additional-changes-to-the-database" class="section level3">
<h3 class="hasAnchor">
<a href="#i-want-to-use-the-automatic-load-but-make-additional-changes-to-the-database" class="anchor"></a>I want to use the automatic load but make additional changes to the database</h3>
<p>You can define two additional actions to the load step, <code>pre_load</code> and <code>post_load</code>. This might be used e.g. to create an index after the data has been added by the automatic load. These can be used by updating the <code>dettl.yml</code> config to be</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">load</span><span class="kw">:</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="at">  </span><span class="fu">pre</span><span class="kw">:</span><span class="at"> pre_load</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="at">  </span><span class="fu">automatic</span><span class="kw">:</span><span class="at"> </span><span class="ch">TRUE</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="at">  </span><span class="fu">post</span><span class="kw">:</span><span class="at"> post_load</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="at">  </span><span class="fu">verification_queries</span><span class="kw">:</span><span class="at"> test_queries</span></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span><span class="at"> R/test_load.R</span></span></code></pre></div>
<p>defining functions <code>pre_load</code> and <code>post_load</code> which take the <code>transformed_data</code> and a DB connection e.g.</p>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="va">pre_load</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">transformed_data</span>, <span class="va">con</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">## Do something</span>
<span class="op">}</span>
<span class="va">post_load</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">transformed_data</span>, <span class="va">con</span><span class="op">)</span> <span class="op">{</span>
  <span class="co">## Do something</span>
<span class="op">}</span></pre></div>
<p>Note that the containing file must be in the list of sources for the import.</p>
</div>
<div id="what-about-cycles" class="section level3">
<h3 class="hasAnchor">
<a href="#what-about-cycles" class="anchor"></a>What about cycles?</h3>
<p>If you have cycles in your database, for example something which looks like</p>
<p><img src="images/cycle_example.png" width="100%"></p>
<p>Then the automatic load can resolve these dependencies if at least one of them is nullable.</p>
<p>e.g. if we want to upload data like</p>
<pre><code>#&gt; $A
#&gt;   id b
#&gt; 1  1 1
#&gt; 2  2 2
#&gt; 
#&gt; $B
#&gt;   id  a
#&gt; 1  1 NA
#&gt; 2  2 NA</code></pre>
<p>this would work. The automatic load would determine that we have a dependency of <code>A</code> on <code>B</code> and of <code>B</code> on <code>A</code> but it would ignore the dependency from <code>B</code> on <code>A</code> because the column in the <code>B</code> table has <code>NA</code> values. It would upload <code>B</code> first which would pass successfully if column <code>a</code> of table <code>B</code> is nullable and then would successfully upload table <code>A</code>.</p>
<p>If we had something like</p>
<pre><code>#&gt; $A
#&gt;   id b
#&gt; 1  1 1
#&gt; 2  2 2
#&gt; 
#&gt; $B
#&gt;   id a
#&gt; 1  1 1
#&gt; 2  2 2</code></pre>
<p>This would fail because the automatic load cannot determine the order that the data should be uploaded in.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert Ashton.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
